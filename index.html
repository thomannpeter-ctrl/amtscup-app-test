<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Amtscup â€“ Cup-Duell</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, Arial, sans-serif;
  background:#f1f5f9;
  margin:0;
  padding:20px;
}
h1 { color:#1e40af; }
.card {
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin-bottom:20px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}
label { font-weight:600; font-size:.85rem; }
input, select {
  width:100%;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid #c7d2fe;
}
table {
  width:100%;
  border-collapse:collapse;
  font-size:.85rem;
}
th, td {
  border:1px solid #e5e7eb;
  padding:6px;
  text-align:center;
}
th { background:#dbeafe; }
tfoot td { background:#f3f4f6; font-weight:700; }
button {
  background:#2563eb;
  color:#fff;
  border:none;
  padding:14px;
  border-radius:999px;
  font-size:1rem;
  width:100%;
  cursor:pointer;
}
.winner {
  padding:10px;
  border-radius:999px;
  font-weight:700;
}
.winner.none { background:#e5e7eb; }
.winner.ok { background:#dcfce7; color:#166534; }
</style>
</head>

<body>

<h1>Amtscup â€“ Cup-Duell</h1>

<div class="card">
<h3>1. Gruppenchef</h3>
<input id="chefName" placeholder="Name Gruppenchef">
<br><br>
<input id="chefMail" placeholder="E-Mail">
</div>

<div class="card">
<h3>2. Gruppenauswahl</h3>
<select id="g1"></select><br><br>
<select id="g2"></select><br><br>
<select id="g3"></select>
</div>

<div id="groups"></div>

<div class="card">
<h3>Sieger</h3>
<div id="winner" class="winner none">Noch keine Resultate</div>
</div>

<div class="card">
<button onclick="sendMail()">ðŸ“§ Resultat senden</button>
</div>

<script>
/* ================= KONFIG ================= */
const RESULT_MAIL = "thomannpeter@bluewin.ch";

const SPORTGERAETE = [
  ["",0],
  ["Standard",0],
  ["FG",0],
  ["Karabiner",4],
  ["57/02",8],
  ["57/03",4],
  ["90BK",4],
  ["90RK",4]
];

const FALLBACK_GROUPS = [
 "1 Heim 1 A071 Worber SportschÃ¼tzen Querschleger",
 "1 Gast 1 A001 AareschÃ¼tzen Kiesen Oppligen Aare",
 "1 Gast 1 A037 Linden FS Innerbirrmoos"
];

let groupNames = ["","",""];

/* ================= GRUPPEN LADEN ================= */
fetch("gruppen.txt?ts="+Date.now(),{cache:"no-store"})
.then(r=>r.ok?r.text():Promise.reject())
.then(text=>initGroups(text.split(/\r?\n/)))
.catch(()=>initGroups(FALLBACK_GROUPS));

function initGroups(list){
  list=list.map(l=>l.trim()).filter(l=>l);
  ["g1","g2","g3"].forEach(id=>{
    const s=document.getElementById(id);
    s.innerHTML="<option value=''>Bitte wÃ¤hlenâ€¦</option>";
    list.forEach(g=>{
      const o=document.createElement("option");
      o.value=o.textContent=g;
      s.appendChild(o);
    });
    s.onchange=renderTables;
  });
}

/* ================= TABELLEN ================= */
function renderTables(){
  const c=document.getElementById("groups");
  c.innerHTML="";
  groupNames=[
    g1.value,
    g2.value,
    g3.value
  ];
  groupNames.forEach((g,i)=>{
    if(!g) return;
    c.appendChild(makeTable(i+1,g));
  });
  calc();
}

function makeTable(n,name){
  const d=document.createElement("div");
  d.className="card";
  d.innerHTML=`<h3>Gruppe ${n}: ${name}</h3>
  <table>
  <thead><tr>
  <th>#</th><th>Name</th><th>Jahrgang</th><th>SportgerÃ¤t</th>
  <th>Resultat</th><th>Zuschlag</th><th>Total</th>
  </tr></thead>
  <tbody>
  ${[1,2,3,4,5].map(i=>row(n,i)).join("")}
  </tbody>
  <tfoot><tr>
  <td colspan="4">Summe</td>
  <td id="r${n}">0</td>
  <td id="z${n}">0</td>
  <td id="t${n}">0</td>
  </tr></tfoot>
  </table>`;
  return d;
}

function row(g,i){
  return `<tr>
  <td>${i}</td>
  <td><input></td>
  <td><input></td>
  <td><select onchange="calc()">
    ${SPORTGERAETE.map(s=>`<option value="${s[1]}">${s[0]}</option>`).join("")}
  </select></td>
  <td><input type="number" oninput="calc()"></td>
  <td>0</td><td>0</td>
  </tr>`;
}

/* ================= BERECHNUNG ================= */
function calc(){
  let totals=[];
  document.querySelectorAll(".card table").forEach((t,i)=>{
    let sr=0,sz=0,st=0;
    t.querySelectorAll("tbody tr").forEach(r=>{
      const res=+r.cells[4].firstChild.value||0;
      const zus=+r.cells[3].firstChild.value||0;
      r.cells[5].textContent=zus;
      r.cells[6].textContent=res+zus;
      sr+=res; sz+=zus; st+=res+zus;
    });
    r=document.getElementById("r"+(i+1)); if(r)r.textContent=sr;
    z=document.getElementById("z"+(i+1)); if(z)z.textContent=sz;
    tt=document.getElementById("t"+(i+1)); if(tt)tt.textContent=st;
    totals.push({name:groupNames[i],total:st});
  });
  showWinner(totals.filter(t=>t.total>0));
}

function showWinner(arr){
  const w=document.getElementById("winner");
  if(!arr.length){ w.textContent="Noch keine Resultate"; return;}
  arr.sort((a,b)=>b.total-a.total);
  if(arr.length===2){
    w.textContent="ðŸ† Sieger: "+arr[0].name+" ("+arr[0].total+")";
  } else {
    w.textContent="ðŸ† Sieger: "+arr[0].name+" & "+arr[1].name;
  }
  w.className="winner ok";
}

/* ================= MAIL ================= */
function sendMail(){
  let body="AMTSCUP CUP-DUELL\n\n";
  body+="Gruppenchef: "+chefName.value+"\n";
  body+="E-Mail: "+chefMail.value+"\n\n";

  document.querySelectorAll(".card table").forEach((t,i)=>{
    body+="Gruppe "+(i+1)+": "+groupNames[i]+"\n";
    t.querySelectorAll("tbody tr").forEach(r=>{
      const name=r.cells[1].firstChild.value;
      if(!name) return;
      body+=`${name}; ${r.cells[2].firstChild.value}; ${r.cells[3].firstChild.options[r.cells[3].firstChild.selectedIndex].text}; ${r.cells[4].firstChild.value}; Zuschlag ${r.cells[5].textContent}; Total ${r.cells[6].textContent}\n`;
    });
    body+="Summe: "+document.getElementById("t"+(i+1)).textContent+"\n\n";
  });

  location.href=
   "mailto:"+RESULT_MAIL+
   "?subject="+encodeURIComponent("Amtscup Resultat")+
   "&body="+encodeURIComponent(body);
}
</script>
</body>
</html>
