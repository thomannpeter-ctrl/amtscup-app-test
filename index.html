<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Amtscup â€“ Cup-Duell</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: system-ui, Arial, sans-serif;
  background:#f3f6f9;
  margin:0;
  padding:1rem;
}
h1{color:#1e40af}
.card{
  background:#fff;
  border-radius:12px;
  padding:1rem;
  margin-bottom:1rem;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:.9rem;
}
th,td{
  border:1px solid #e5e7eb;
  padding:.3rem;
  text-align:center;
}
th{background:#dbeafe}
input,select{
  width:100%;
  padding:.3rem;
  border-radius:6px;
  border:1px solid #c7d2fe;
}
input[type=number]{max-width:80px}
.name{max-width:160px}
.sum{background:#f1f5f9;font-weight:bold}
button{
  width:100%;
  padding:.8rem;
  border:none;
  border-radius:999px;
  background:#2563eb;
  color:#fff;
  font-size:1rem;
  cursor:pointer;
}
.winner{
  background:#dcfce7;
  padding:.7rem;
  border-radius:999px;
  font-weight:bold;
}
</style>
</head>

<body>

<h1>Amtscup â€“ Cup-Duell</h1>

<div class="card">
<h3>1. Gruppenchef</h3>
<input id="chefName" placeholder="Name Gruppenchef">
<input id="chefMail" placeholder="E-Mail">
</div>

<div class="card">
<h3>2. Gruppenauswahl</h3>
<select id="g1"></select>
<select id="g2"></select>
<select id="g3">
  <option value="">keine 3. Gruppe</option>
</select>
</div>

<div id="tables"></div>

<div class="card">
<h3>Sieger</h3>
<div id="winner" class="winner">Noch keine Resultate</div>
</div>

<button onclick="sendAll()">ðŸ“¨ Resultat senden</button>

<script>
/* ================== KONFIG ================== */
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbzMc02eHBrvhcq3oma4tNOE3SwS5W-ax0HP73_QfVnF5I9y-ngdVKTpFNTaYm6xvbkE-A/exec";

const RESULT_MAIL = "thomannpeter@bluewin.ch";

const SPORTGERAETE = {
  "":0,
  "Standard":0,
  "FG":0,
  "Karabiner":4,
  "57/02":8,
  "57/03":4,
  "90BK":4,
  "90RK":4
};
/* ============================================ */

const selects=[g1,g2,g3];
const tables=document.getElementById("tables");

/* Gruppen laden */
fetch("gruppen.txt?"+Date.now())
.then(r=>r.text())
.then(t=>{
  const list=t.split(/\r?\n/).filter(x=>x.trim());
  selects.forEach(sel=>{
    sel.innerHTML='<option value="">Bitte wÃ¤hlenâ€¦</option>';
    list.forEach(g=>{
      const o=document.createElement("option");
      o.textContent=o.value=g;
      sel.appendChild(o);
    });
  });
});

/* Tabellen neu aufbauen */
selects.forEach(sel=>sel.onchange=buildTables);

function buildTables(){
  tables.innerHTML="";
  [g1,g2,g3].forEach((sel,i)=>{
    if(!sel.value) return;
    tables.appendChild(makeTable(i+1,sel.value));
  });
}

function makeTable(n,name){
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`<h3>Gruppe ${n}: ${name}</h3>
<table>
<thead>
<tr>
<th>#</th><th>Name</th><th>Jahrgang</th>
<th>SportgerÃ¤t</th><th>Resultat</th>
<th>Zuschlag</th><th>Total</th>
</tr>
</thead>
<tbody>
${[1,2,3,4,5].map(i=>row(n,i)).join("")}
</tbody>
<tfoot>
<tr class="sum">
<td colspan="4">Summe</td>
<td id="sr${n}">0</td>
<td id="sz${n}">0</td>
<td id="st${n}">0</td>
</tr>
</tfoot>
</table>`;
return card;
}

function row(g,i){
  return `<tr data-g="${g}">
<td>${i}</td>
<td><input class="name"></td>
<td><input type="number" min="1900" max="2100"></td>
<td>
<select onchange="calc(this)">
${Object.keys(SPORTGERAETE).map(k=>`<option>${k}</option>`).join("")}
</select>
</td>
<td><input type="number" min="0" max="150" oninput="calc(this)"></td>
<td class="z">0</td>
<td class="t">0</td>
</tr>`;
}

function calc(el){
  const tr=el.closest("tr");
  const res=+tr.children[4].firstChild.value||0;
  const g=tr.children[3].firstChild.value;
  const z=SPORTGERAETE[g]||0;
  tr.children[5].textContent=z;
  tr.children[6].textContent=res+z;
  sum();
}

function sum(){
  [1,2,3].forEach(g=>{
    let sr=0,sz=0,st=0;
    document.querySelectorAll(`tr[data-g="${g}"]`).forEach(tr=>{
      sr+=+tr.children[4].firstChild.value||0;
      sz+=+tr.children[5].textContent||0;
      st+=+tr.children[6].textContent||0;
    });
    if(document.getElementById("sr"+g)){
      sr${g}.textContent=sr;
      sz${g}.textContent=sz;
      st${g}.textContent=st;
    }
  });
  winner();
}

function winner(){
  const totals=[];
  [g1,g2,g3].forEach((s,i)=>{
    if(!s.value) return;
    totals.push({name:s.value,total:+document.getElementById("st"+(i+1)).textContent});
  });
  totals.sort((a,b)=>b.total-a.total);
  winner.textContent=totals.length
   ? "ðŸ† Sieger: "+totals[0].name+" ("+totals[0].total+")"
   : "Noch keine Resultate";
}

/* ================= SENDEN ================= */
function sendAll(){
  const data=[];
  document.querySelectorAll("tr[data-g]").forEach(tr=>{
    const g=tr.dataset.g;
    const name=tr.children[1].firstChild.value;
    if(!name) return;
    data.push({
      gruppe:g,
      gruppenname:[g1,g2,g3][g-1].value,
      name,
      jahrgang:tr.children[2].firstChild.value,
      geraet:tr.children[3].firstChild.value,
      resultat:tr.children[4].firstChild.value,
      zuschlag:tr.children[5].textContent,
      total:tr.children[6].textContent,
      chef:chefName.value,
      email:chefMail.value
    });
  });

  /* Google Tabelle */
  fetch(SCRIPT_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:"payload="+encodeURIComponent(JSON.stringify(data))
  });

  /* Mail */
  let body="AMTSCUP CUP-DUELL\n\n";
  data.forEach(d=>{
    body+=`${d.gruppenname}\n${d.name} ${d.jahrgang} ${d.geraet} Resultat:${d.resultat} Zuschlag:${d.zuschlag} Total:${d.total}\n\n`;
  });

  location.href=
  `mailto:${RESULT_MAIL}?subject=Amtscup Resultat&body=`+
  encodeURIComponent(body);
}
</script>

</body>
</html>
