<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Amtscup â€“ Cup-Duell</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:#eef2f7;margin:0;color:#111827}
.container{max-width:1200px;margin:auto;padding:1rem}
h1{color:#1e3a8a}
h2{color:#1d4ed8;margin:.5rem 0}
.card{background:#fff;border-radius:14px;padding:1rem 1.25rem;
box-shadow:0 4px 10px rgba(15,23,42,.08);margin-bottom:1rem}

.row{display:flex;gap:.75rem;flex-wrap:wrap}
.field{flex:1;min-width:220px}
label{font-size:.8rem;font-weight:600}

input,select{
  width:100%;padding:.45rem;border-radius:8px;
  border:1px solid #cbd5f5
}

.input-year{max-width:80px}
.input-result{max-width:70px}

input.error{border-color:#dc2626;background:#fee2e2}

table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{border:1px solid #e5e7eb;padding:.4rem;text-align:center}
th{background:#dbeafe}
.sum{background:#f3f4f6;font-weight:700}

button{
  border:none;border-radius:999px;padding:.8rem;
  font-size:1rem;cursor:pointer;
  background:#2563eb;color:white;width:100%
}

.winner{
  padding:.7rem;border-radius:999px;
  font-weight:700
}
.winner-ok{background:#dcfce7;color:#166534}
.winner-none{background:#e5e7eb;color:#374151}

@media(max-width:768px){
  table{display:block;overflow-x:auto;white-space:nowrap}
}
</style>
</head>

<body>
<div class="container">

<h1>Amtscup â€“ Cup-Duell</h1>

<!-- Gruppenchef -->
<div class="card">
<h2>1. Gruppenchef</h2>
<div class="row">
  <div class="field"><label>Name</label><input id="chef"></div>
  <div class="field"><label>E-Mail</label><input id="email" type="email"></div>
</div>
</div>

<!-- Gruppenwahl -->
<div class="card">
<h2>2. Gruppenauswahl</h2>
<div class="row">
  <div class="field"><label>Gruppe 1 *</label><select id="g1"></select></div>
  <div class="field"><label>Gruppe 2 *</label><select id="g2"></select></div>
  <div class="field"><label>Gruppe 3 (optional)</label><select id="g3"></select></div>
</div>
</div>

<div id="groups"></div>

<div class="card">
<h2>Sieger</h2>
<div id="winner" class="winner winner-none">Noch keine Resultate</div>
</div>

<div class="card">
<button onclick="sendResult()">ðŸ“§ Resultat senden</button>
</div>

</div>

<script>
/* ================= KONFIG ================= */
const RESULT_EMAIL="thomannpeter@bluewin.ch";

const SPORTGERAETE=[
  {n:"",z:0},
  {n:"Standard",z:0},
  {n:"FG",z:0},
  {n:"Karabiner",z:4},
  {n:"57/02",z:8},
  {n:"57/03",z:4},
  {n:"90BK",z:4},
  {n:"90RK",z:4}
];

function zuschlagFor(geraet){
  const g = SPORTGERAETE.find(x=>x.n===geraet);
  return g ? g.z : 0;
}

/* ================= GRUPPEN LADEN ================= */
async function loadGroups(){
  const r=await fetch("gruppen.txt?ts="+Date.now(),{cache:"no-store"});
  const list=r.ok?(await r.text()).split(/\r?\n/).filter(l=>l.trim()):[];
  ["g1","g2","g3"].forEach(id=>{
    const s=document.getElementById(id);
    s.innerHTML="<option value=''>Bitte wÃ¤hlen â€¦</option>";
    list.forEach(g=>{
      const o=document.createElement("option");
      o.value=o.textContent=g;
      s.appendChild(o);
    });
    s.onchange=buildGroups;
  });
}

/* ================= GRUPPEN ERZEUGEN ================= */
function buildGroups(){
  const cont=document.getElementById("groups");
  cont.innerHTML="";
  [1,2,3].forEach(n=>{
    const name=document.getElementById("g"+n).value;
    if(!name) return;
    cont.appendChild(createGroup(n,name));
  });
  calcWinner();
}

function createGroup(n,name){
  const c=document.createElement("div");
  c.className="card";
  c.dataset.groupN = String(n);
  c.dataset.groupName = name;

  c.innerHTML=`
  <h2>Gruppe ${n}: ${name}</h2>
  <table>
  <thead><tr>
  <th>#</th><th>Name</th><th>Jahrgang</th><th>SportgerÃ¤t</th>
  <th>Resultat</th><th>Zuschlag</th><th>Total</th>
  </tr></thead><tbody></tbody>
  <tfoot><tr>
  <th colspan="4">Summe</th>
  <th class="sr">0</th><th class="sz">0</th><th class="st">0</th>
  </tr></tfoot></table>`;

  const tb=c.querySelector("tbody");

  for(let i=1;i<=5;i++){
    const tr=document.createElement("tr");
    tr.innerHTML=`
    <td>${i}</td>
    <td><input class="in-name"></td>
    <td><input type="number" class="input-year in-year" min="1900" max="2099"></td>
    <td><select class="in-geraet"></select></td>
    <td><input type="number" class="input-result in-res" min="0" max="150"></td>
    <td class="z">0</td>
    <td class="t">0</td>`;

    const sel=tr.querySelector(".in-geraet");
    SPORTGERAETE.forEach(g=>{
      const o=document.createElement("option");
      o.value=o.textContent=g.n;
      sel.appendChild(o);
    });

    tr.querySelectorAll("input,select").forEach(el=>{
      el.addEventListener("input", ()=>calcGroup(c));
      el.addEventListener("change", ()=>calcGroup(c));
    });

    tb.appendChild(tr);
  }
  return c;
}

/* ================= BERECHNUNG ================= */
function calcGroup(card){
  let sr=0,sz=0,st=0;

  card.querySelectorAll("tbody tr").forEach(tr=>{
    const resInput = tr.querySelector(".in-res");
    let res = +resInput.value || 0;

    if(res > 150){
      alert("Max Resultat 150");
      res = 150;
      resInput.value = 150;
    }
    if(res < 0){
      res = 0;
      resInput.value = 0;
    }

    const geraet = tr.querySelector(".in-geraet").value;
    const z = zuschlagFor(geraet);

    tr.querySelector(".z").textContent = z;
    tr.querySelector(".t").textContent = res + z;

    sr += res;
    sz += z;
    st += (res + z);
  });

  card.querySelector(".sr").textContent=sr;
  card.querySelector(".sz").textContent=sz;
  card.querySelector(".st").textContent=st;

  calcWinner();
}

/* ================= SIEGER ================= */
function calcWinner(){
  const cards = [...document.querySelectorAll("#groups .card")];

  const entries = cards.map(card=>{
    const name = card.dataset.groupName || ("Gruppe " + (card.dataset.groupN||"?"));
    const total = +card.querySelector(".st")?.textContent || 0;
    return { name, total };
  }).filter(x => x.total > 0);

  const box=document.getElementById("winner");

  if(!entries.length){
    box.textContent="Noch keine Resultate";
    box.className="winner winner-none";
    return;
  }

  entries.sort((a,b)=>b.total-a.total);

  // Wenn 3 Gruppen vorhanden (ausgewÃ¤hlt) -> Top 2 Sieger
  const groupsSelected = [g1.value, g2.value, g3.value].filter(Boolean).length;
  const topCount = (groupsSelected >= 3) ? 2 : 1;

  const winners = entries.slice(0, topCount);

  box.className="winner winner-ok";
  if(topCount === 1){
    box.textContent = `ðŸ† Sieger: ${winners[0].name} (${winners[0].total})`;
  }else{
    box.textContent = `ðŸ† Sieger: ${winners[0].name} (${winners[0].total}) & ${winners[1].name} (${winners[1].total})`;
  }
}

/* ================= MAIL ================= */
function sendResult(){
  // Mindest-Check
  if(!g1.value || !g2.value){
    alert("Bitte mindestens Gruppe 1 und Gruppe 2 auswÃ¤hlen.");
    return;
  }

  // Pflicht: Gruppenchef
  if(!chef.value.trim() || !email.value.trim()){
    alert("Bitte Name und E-Mail vom Gruppenchef ausfÃ¼llen.");
    return;
  }

  // Mail-Text bauen
  let body="AMTSCUP CUP-DUELL\n\n";
  body += `Gruppenchef: ${chef.value}\n`;
  body += `E-Mail: ${email.value}\n\n`;

  const cards = [...document.querySelectorAll("#groups .card")];

  cards.forEach((card, idx)=>{
    const groupName = card.dataset.groupName || `Gruppe ${idx+1}`;
    const sumRes = card.querySelector(".sr")?.textContent || "0";
    const sumZ   = card.querySelector(".sz")?.textContent || "0";
    const sumTot = card.querySelector(".st")?.textContent || "0";

    body += `GRUPPE ${idx+1}: ${groupName}\n`;
    body += "Name;Jahrgang;SportgerÃ¤t;Resultat;Zuschlag;Total\n";

    card.querySelectorAll("tbody tr").forEach(tr=>{
      const name = tr.querySelector(".in-name").value.trim();
      const year = tr.querySelector(".in-year").value.trim();
      const geraet = tr.querySelector(".in-geraet").value.trim();
      const res = tr.querySelector(".in-res").value.trim();
      const z = tr.querySelector(".z").textContent.trim();
      const t = tr.querySelector(".t").textContent.trim();

      // nur Zeilen mit Inhalt
      if(!name && !year && !geraet && !res) return;

      body += `${name};${year};${geraet};${res};${z};${t}\n`;
    });

    body += `SUMME; ; ;${sumRes};${sumZ};${sumTot}\n\n`;
  });

  // Siegertext auch im Mail
  body += "SIEGER:\n" + document.getElementById("winner").textContent + "\n";

  // Mail Ã¶ffnen
  location.href =
   "mailto:"+encodeURIComponent(RESULT_EMAIL)+
   "?subject="+encodeURIComponent("Amtscup Resultat")+
   "&body="+encodeURIComponent(body);
}

/* ================= START ================= */
loadGroups();
</script>

</body>
</html>
